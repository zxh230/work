第一题，(后面有自动脚本)
```shell
cat >> curl-php.yaml << EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: php-conf
data:
  www.conf: |
    ; Unix user/group of processes
    user = www-data
    group = www-data

    ; The address on which to accept FastCGI requests
    listen = 0.0.0.0:9000

    ; Set the process manager
    pm = dynamic

    ; The number of child processes to be created when pm is set to static and the maximum number of
    ; child processes to be created when pm is set to dynamic or ondemand.
    pm.max_children = 5

    ; The number of child processes created on startup.
    pm.start_servers = 2

    ; The minimum number of idle processes.
    pm.min_spare_servers = 1

    ; The maximum number of idle processes.
    pm.max_spare_servers = 3
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: html-php
data:
  index.php: |
    <?php
    error_reporting(E_ALL);
    ini_set('display_errors', 1);

    $db_host = '10.15.200.243';
    $db_name = 'zxh';
    $db_user = 'root';
    $db_pass = '123.com';
    try {
        $dsn = "mysql:host=$db_host;port=$db_port;dbname=$db_name";
        $options = array(
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_TIMEOUT => 5, // 设置连接超时
        );
        $dbh = new PDO($dsn, $db_user, $db_pass, $options);
        echo '非常开心，数据库连接成功！！！<br>';
    } catch (PDOException $e) {
        echo '恭喜恭喜，数据库连接失败~~~<br>';
        echo '错误信息： ' . $e->getMessage() . '<br>';
        echo '错误代码： ' . $e->getCode() . '<br>';
    }
    phpinfo();
    ?>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: php
  template:
    metadata:
      labels:
        app: php
      annotations:
        cni.projectcalico.org/ipv4pools: '["10.10.0.0/16"]'
    spec:
      containers:
      - name: php
        image: php:8.1-fpm
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9000
        env:
        - name: DB_HOST
          value: "mysqlsvc"
        - name: DB_PORT
          value: "3306"
        command: ["/bin/sh"]
        args:
        - "-c"
        - |
          docker-php-ext-install mysqli pdo pdo_mysql &&           mkdir -p /usr/share/nginx/html &&           php-fpm
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html/
        - name: conf
          mountPath: /usr/local/etc/php-fpm.d/www.conf
          subPath: www.conf
      volumes:
      - name: html
        configMap:
          name: html-php
      - name: conf
        configMap:
          name: php-conf
---
apiVersion: v1
kind: Service
metadata:
  name: php-zxh
spec:
  type: ClusterIP
  clusterIP: 10.10.0.1
  selector:
    app: php
  ports:
    - port: 9000
      targetPort: 9000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
data:
  aaa.conf: |
    server {
      listen 443 ssl;
      server_name www.zxh.com;
      root /usr/share/nginx/html;
      index index.php index.html index.htm;
      ssl_certificate /etc/nginx/ssl/tls.crt;
      ssl_certificate_key /etc/nginx/ssl/tls.key;

      location ~ \.php$ {
        fastcgi_pass 10.10.0.1:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      }
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: nginx-tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURPVENDQWlHZ0F3SUJBZ0lVUVp0NmFZcmtlVFNQdWd3Y2lEOXZkTVpXVE9Rd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0xERVVNQklHQTFVRUF3d0xkM2QzTG5wNGFDNWpiMjB4RkRBU0JnTlZCQW9NQzNkM2R5NTZlR2d1WTI5dApNQjRYRFRJME1EZ3dPREEyTlRNeU5sb1hEVEkxTURnd09EQTJOVE15Tmxvd0xERVVNQklHQTFVRUF3d0xkM2QzCkxucDRhQzVqYjIweEZEQVNCZ05WQkFvTUMzZDNkeTU2ZUdndVkyOXRNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUYKQUFPQ0FROEFNSUlCQ2dLQ0FRRUFzTWVvY1BnMUlncGE1MzJhNTZjbS9qUEVWSUUvNzlEelVmKzFaNmxFYkpoQgpCQlFlOTlXSWZIaVN5T1MxRDQ2bk5NeXR5VFZFdElja3FXVnROZVAwNFNFYXI3MlRlb0lnWDZIK0ZRakRId1VaCktjd3FkbnRSZjRmZTRVM01LRTBhUTd2TFdxRFF5QTZ4dGg0bDUvQk8xWmVrUTdwRjFhOUVUY0NoeVYxelZQT2sKRURkc0JZK3NGQXV1WVlJbG0xQ0grTG5xL1JoZDg0M25Odm43b1BvK2toOUJZdjQzbjEwWTJzeitrczU3aUtJaQpkcmxOQzJORldua3lLM05iblVMWW96SjFHaUhCeHhHSGdsNWFOM2tIMU5FRUhicWtCeTdhcHVUVHoyenJncnhBCjdUNGdLSnJnWlRkZHB6alRJR281V3dxUlNSRUQ1YnFCU1hiT3pLTE1xUUlEQVFBQm8xTXdVVEFkQmdOVkhRNEUKRmdRVTBvaUtwV0ZtYWJsamd0ZXlXVHBHaWpzYmZZa3dId1lEVlIwakJCZ3dGb0FVMG9pS3BXRm1hYmxqZ3RleQpXVHBHaWpzYmZZa3dEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFhZ1dnCnorU1QxVlFnRlFiV3ZIVGJhVHJkZksrdGtUWjI1YkdLbnYxRjM2WUdneUVnV2EwSkZYdHRMK1IzK2ZIK1k1dnMKbVdUZ1RIREFldlpzcHZpR09Ia3QwbFJnYTFsc3ovc29oMVFOWVcrOUlTUC8zWkVjQ0RpWm9ZbkZITStVUTBFMApPU3psajdkMXJON2lVL0lnejBzYktBZTB0WHgxeHVaQzRMY3krTEdGeVM4M2pHWk9NOXloa3JQUkRZd3UvRTAwCjZOQ1ZISEtENU5CWjA4YlFSQVEvQVVNdXBUU0g2c2VRTmp3YmlacGdDb2dJNzJSaVUreGJqMmhvM1dMeS84YUoKaE4rSXBKV01yeVljSU1sK0xXV2lEU0o4N2p4UU04STc0UFZtMDF2eXllTEZSNEJYcmRMOEJxekgzZjJHYTlVagpJOFZOaTV4NmtGaWFJTHRTNUE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQ3d4Nmh3K0RVaUNscm4KZlpybnB5YitNOFJVZ1QvdjBQTlIvN1ZucVVSc21FRUVGQjczMVloOGVKTEk1TFVQanFjMHpLM0pOVVMwaHlTcApaVzAxNC9UaElScXZ2Wk42Z2lCZm9mNFZDTU1mQlJrcHpDcDJlMUYvaDk3aFRjd29UUnBEdTh0YW9ORElEckcyCkhpWG44RTdWbDZSRHVrWFZyMFJOd0tISlhYTlU4NlFRTjJ3Rmo2d1VDNjVoZ2lXYlVJZjR1ZXI5R0YzemplYzIKK2Z1ZytqNlNIMEZpL2plZlhSamF6UDZTem51SW9pSjJ1VTBMWTBWYWVUSXJjMXVkUXRpak1uVWFJY0hIRVllQwpYbG8zZVFmVTBRUWR1cVFITHRxbTVOUFBiT3VDdkVEdFBpQW9tdUJsTjEybk9OTWdhamxiQ3BGSkVRUGx1b0ZKCmRzN01vc3lwQWdNQkFBRUNnZ0VBUFdGOTg0ZkRUeWdBUzF1YUF6QlBRamx3UkpWQ1FYOHdWVHJ2M21md0NiTE4KOUdBV0pxQitqUldDaGYyZmZxRGVIdCtvd2ZIY2dzQmY4dTkwUForQ29mN1FHTkErMm0wL1YyVlVaekpOS2NLbgo2NUxuOVk2NURBcDkwWVlsU3FNRzZSaldNWWdnSmk2djl0ZTkrcXcrZXp4MWZVeTZ2Y2ptOHdaZFJxRkxqK1dhCldkZmJNZUoyUU03Qmk5S1JaVmdUNWpOSFRYMHZXOUw0YWVsWnZKVXVqR2tvVFVJN21qZDJTWktIVVVmTFNrMkQKR1M1ZWpmMURGU3BmOENOQ1NWeDF5Yy82VG1FZFhRRVJuRnVFaFhickk0STQxMkU3VXZnVk9Ibm52K2NwalRLOQpGOTZKOWttVU9YVWF1KzcvTk1DeVRLM0o5SVZCT044aklHZnR6QWo4andLQmdRQytIYkVaL1FuOWFxRDJWbmxmCk10YlN2b0RUSkVLVTVJcko2d3JRRCtOTGJCd2o2VWJpRTdlbkVySFp4bTRpNTI5OGMvenZxM3k5aFNWS1NRaS8KTEZTUncwU1lGMk1UWWNiazJJaEZyWm5WMm5BVzlDYi9BaWVzNWhRaHBSWjZncGlMRWUwZ1dDa0VGTGFmTENUUwo2eFFlay95UGNuSEx2SmRjaHN1YzlJaDF5d0tCZ1FEdUN0aE1pUEh6YytJdDBab0NxM3lMdW9RdWNmK3ROQmFyCmdRRFhvWXlpaGl6U2ZVVlJFdjB1OGVLVWNLMFdaT0NldVYvdWpzeGVLMjRwaGNnUTRLaGJNMUVtSzllVEp3TWMKc0F0NVpxQk9jUUdQeGxoVkNRb3JTZXhyU3RoNXNWaSt6MzI3TlRqWVo1aHppejNuMVJVTGkrSmJCbTAwWS9pTApubkxhTHpFWTJ3S0JnUUNHQ3FzMmRwa1hpcG1JZFhuSHJER1lqdWFIZDdaV0FqajBtbnFhTGNtRkFPbHFUR3hFCnM4QTExTkYraVJCWUhiTVdIVFZGeWpQOTc2VldGZDVMNDdhUXV3dGU3SVpYUVFZWmphMnU2dkpldkU5eGI1MGIKQ09ydVZaMzJCczZ0ZSt5UGlRa1dWL0k3UlZ0cEtKZWgra3JLTUc3T3VOTVE0WndhaVpOL3kwMTNOd0tCZ1FDVgpYTlN2NFZYLzduekRSenVkNVVCMjVJZkFKT1BMS0YzNUt5NytIbTRDSkxMSE9MZGYwY3h2d25McnRXL0dGM0loCjVpdGRvdGgxVmtiL1l1UlFRc2Nnd3FodWpSL3RRNU5lVXRCQVVyYlB3WFM3WkRkVTFDRS9YRmt1VVg1WGpZSWoKNkVuNlI4RHRlTU5kN01iaFN3Q3ppQWgyR1NnNHNXbnBJWGpya3FUNTlRS0JnQUd3dW9GNFlWaVpDcEZORmxrNgprSERiVXhmNHhKcUVTcm9sT2lqL3F0ZHF0QzkyVGlNTDJaZTF1TjBuc05zN1poSGVRYy9CRWUySk92RytaWG1CCkFJSjRuamhJU00zVXFWZ2tKWjRCdU1KSFVjajVJMzZoVGlqbHBSS1BVc3ZvSmVCdzJpZG1uT2lmd2hBYi8wUGEKdXk3MWVHRDM1VTBuc3dUSUlKdmJlYkkvCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
type: kubernetes.io/tls
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
      annotations:
        cni.projectcalico.org/ipv4pools: '["10.10.0.0/16"]'
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 443
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
        - name: nginx-html
          mountPath: /usr/share/nginx/html
        - name: tls
          mountPath: /etc/nginx/ssl/
          readOnly: true
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-conf
      - name: nginx-html
        configMap:
          name: html-php
      - name: tls
        secret:
          secretName: nginx-tls
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-zxh
spec:
  selector:
    app: nginx
  ports:
    - port: 443
      targetPort: 443
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "https"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - www.zxh.com
    secretName: nginx-tls
  rules:
  - host: www.zxh.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-zxh
            port:
              number: 443
```
脚本
```shell
#!/bin/bash
# 检查kube-apiserver配置
APISERVER_CONFIG="/etc/kubernetes/manifests/kube-apiserver.yaml"
if ! grep -q "\- --service-cluster-ip-range=10.10.0.0/16" "$APISERVER_CONFIG"; then
    echo "警告: kube-apiserver配置中的service-cluster-ip-range不是10.10.0.0/16"
    read -p "是否要更改为10.10.0.0/16? (y/n): " change_config
    if [[ $change_config == "y" ]]; then
        sudo sed -i 's/- --service-cluster-ip-range=[0-9./]*/- --service-cluster-ip-range=10.10.0.0\/16/' "$APISERVER_CONFIG"
        echo "配置已更新,正在重启服务..."
        sudo systemctl daemon-reload
        sudo systemctl restart kubelet.service containerd.service
    else
        echo "未更改配置,脚本将退出."
        exit 1
    fi
fi

# 询问用户输入
read -p "请输入PHP服务的名字: " php_svc_name
read -p "请输入Nginx服务的名字: " nginx_svc_name
read -p "请输入域名全名(如：www.zxh.com): " domain_name
read -p "请输入MySQL节点的IP地址: " mysql_ip

# 生成SSL证书和密钥
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=$domain_name/O=$domain_name"
tls_crt=$(base64 -w 0 tls.crt)
tls_key=$(base64 -w 0 tls.key)

# 移动证书
cp ./tls.crt /etc/pki/ca-trust/source/anchors/aaa.crt

# 载入证书
update-ca-trust

# 创建部署文件
cat <<EOF > deployment.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: php-conf
data:
  www.conf: |
    ; Unix user/group of processes
    user = www-data
    group = www-data

    ; The address on which to accept FastCGI requests
    listen = 0.0.0.0:9000

    ; Set the process manager
    pm = dynamic

    ; The number of child processes to be created when pm is set to static and the maximum number of
    ; child processes to be created when pm is set to dynamic or ondemand.
    pm.max_children = 5

    ; The number of child processes created on startup.
    pm.start_servers = 2

    ; The minimum number of idle processes.
    pm.min_spare_servers = 1

    ; The maximum number of idle processes.
    pm.max_spare_servers = 3
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: html-php
data:
  index.php: |
    <?php
    error_reporting(E_ALL);
    ini_set('display_errors', 1);

    \$db_host = '$mysql_ip';
    \$db_name = 'zxh';
    \$db_user = 'root';
    \$db_pass = '123.com';
    try {
        \$dsn = "mysql:host=\$db_host;port=\$db_port;dbname=\$db_name";
        \$options = array(
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_TIMEOUT => 5, // 设置连接超时
        );
        \$dbh = new PDO(\$dsn, \$db_user, \$db_pass, \$options);
        echo '非常开心，数据库连接成功！！！<br>';
    } catch (PDOException \$e) {
        echo '恭喜恭喜，数据库连接失败~~~<br>';
        echo '错误信息： ' . \$e->getMessage() . '<br>';
        echo '错误代码： ' . \$e->getCode() . '<br>';
    }
    phpinfo();
    ?>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: php
  template:
    metadata:
      labels:
        app: php
      annotations:
        cni.projectcalico.org/ipv4pools: '["10.10.0.0/16"]'
    spec:
      containers:
      - name: php
        image: php:8.1-fpm
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9000
        env:
        - name: DB_HOST
          value: "mysqlsvc"
        - name: DB_PORT
          value: "3306"
        command: ["/bin/sh"]
        args:
        - "-c"
        - |
          docker-php-ext-install mysqli pdo pdo_mysql && \
          mkdir -p /usr/share/nginx/html && \
          php-fpm
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html/
        - name: conf
          mountPath: /usr/local/etc/php-fpm.d/www.conf
          subPath: www.conf
      volumes:
      - name: html
        configMap:
          name: html-php
      - name: conf
        configMap:
          name: php-conf
---
apiVersion: v1
kind: Service
metadata:
  name: $php_svc_name
spec:
  type: ClusterIP
  clusterIP: 10.10.0.1
  selector:
    app: php
  ports:
    - port: 9000
      targetPort: 9000
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
data:
  aaa.conf: |
    server {
      listen 443 ssl;
      server_name $domain_name;
      root /usr/share/nginx/html;
      index index.php index.html index.htm;
      ssl_certificate /etc/nginx/ssl/tls.crt;
      ssl_certificate_key /etc/nginx/ssl/tls.key;

      location ~ \.php$ {
        fastcgi_pass 10.10.0.1:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
      }
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: nginx-tls
data:
  tls.crt: $tls_crt
  tls.key: $tls_key
type: kubernetes.io/tls
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
      annotations:
        cni.projectcalico.org/ipv4pools: '["10.10.0.0/16"]'
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 443
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d
        - name: nginx-html
          mountPath: /usr/share/nginx/html
        - name: tls
          mountPath: /etc/nginx/ssl/
          readOnly: true
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-conf
      - name: nginx-html
        configMap:
          name: html-php
      - name: tls
        secret:
          secretName: nginx-tls
---
apiVersion: v1
kind: Service
metadata:
  name: $nginx_svc_name
spec:
  selector:
    app: nginx
  ports:
    - port: 443
      targetPort: 443
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "https"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - $domain_name
    secretName: nginx-tls
  rules:
  - host: $domain_name
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: $nginx_svc_name
            port:
              number: 443
EOF

echo "Kubernetes deployment file 'deployment.yaml' 已生成."

# 部署
kubectl apply -f deployment.yaml

# 等待部署完成
echo "等待部署完成..."
kubectl rollout status deployment/php-pod
kubectl rollout status deployment/nginx

# 查看服务
echo "服务状态:"
kubectl get svc

# 询问是否监控pod
read -p "是否要监控pod? (y/n): " monitor_pods
if [[ $monitor_pods == "y" ]]; then
    kubectl get pods -w
fi

echo "部署完成."
```

第二题

```shell

```