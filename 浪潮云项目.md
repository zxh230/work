环境：
因为 k 8 s 主节点有污点不会调度 pod，所以提高从节点资源

k8s主节点：kube 01 (4 G 内存，4 核 cpu)  10.15.200.241

k8s从节点：kube 02 (8 G 内存，6 核 cpu)  10.15.200.242

docker 环境：kube 03 (4 G 内存，4 核 cpu)  10.15.200.243

配置 nfs
```shell
#kube02(nfs-server)
yum install nfs-utils
vim /etc/exports
###
/mydata/nfs/jenkins *(rw,sync,no_root_squash,no_subtree_check)
/mydata/nfs/pgsql *(rw,sync,no_root_squash,no_subtree_check)
/mydata/nfs/sonarqube *(rw,sync,no_root_squash,no_subtree_check)
###
# 创建目录
mkdir -p /mydata/nfs
mkdir /mydata/nfs/pgsql
mkdir /mydata/nfs/jenkins
mkdir /mydata/nfs/sonarqube
chmod 777 /mydata -R
# 重启nfs-server
systemctl restart nfs-server.service 
# 检查nfs
showmount -e 10.15.200.241
exportfs -a
exportfs -s
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831182610.png)

```shell
# kube01
# 创建配置目录
kubectl create ns devops
mkdir -p /mydata/devops/sonarqube/
cd /mydata/devops/sonarqube/
# 部署postgresql
vim postgresql.yaml
###
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pgsql-nfs
  namespace: devops
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: "managed-nfs-storage"
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /mydata/nfs/pgsql
    server: 10.15.200.242
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgress-data
  namespace: devops
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: "managed-nfs-storage"
  resources:
    requests:
      storage: 5Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-sonar
  namespace: devops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-sonar
  template:
    metadata:
      labels:
        app: postgres-sonar
    spec:
      containers:
      - name: postgres-sonar
        image: registry.inspurcloud.cn/devops-cicd/postgres:v1
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "sonarDB"
        - name: POSTGRES_USER
          value: "sonarUser"
        - name: POSTGRES_PASSWORD
          value: "admin123456"
        volumeMounts:
          - name: data
            mountPath: /var/lib/postgresql/data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: postgress-data
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-sonar
  namespace: devops
spec:
  type: NodePort
  ports:
  - name: postgres-sonar
    port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app: postgres-sonar
###
# 部署
kubectl  apply -f pgsql.yaml 
# 查看
kubectl get po -n devops
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831192232.png)

```shell
# 部署sonarqube
vim sonarqube.yaml
### 更改IP地址为nfs-server的IP地址
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sonarqube-nfs
  namespace: devops
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: "managed-nfs-storage"
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /mydata/nfs/sonarqube
    server: 10.15.200.242
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sonarqube-data
  namespace: devops
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: "managed-nfs-storage"
  resources:
    requests:
      storage: 5Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarqube
  namespace: devops
  labels:
    app: sonarqube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sonarqube
  template:
    metadata:
      labels:
        app: sonarqube
    spec:
      #imagePullsecrets:
      #- name: harbor-secret
      initContainers: ##▒~H~]▒~K▒~L~V容▒~Y▒
      - name: init-sysctl
        image: registry.inspurcloud.cn/devops-cicd/busybox:v1
        command: ["sysctl","-w","vm.max_map_count=262144"]
        securityContext:
          privileged: true
      containers:
      - name: sonarqube
        image: registry.inspurcloud.cn/devops-cicd/sonarqube:10.1.0-community
        ports:
        - containerPort: 9000
        env:
        - name: SONARQUBE_JDBC_USERNAME
          value: "sonarUser"
        - name: SONARQUBE_JDBC_PASSWORD
          value: "admin123456"
        - name: SONARQUBE_JDBC_URL
          value: "jdbc:postgresql://postgres-sonar:5432/sonarDB"
        livenessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 30
          periodSeconds: 30
          failureThreshold: 6
        volumeMounts:
          - mountPath: /opt/sonarqube/conf
            name: data
          - mountPath: /opt/sonarqube/data
            name: data
          - mountPath: /opt/sonarqube/extensions
            name: data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: sonarqube-data
---
apiVersion: v1
kind: Service
metadata:
  name: sonarqube
  namespace: devops
spec:
  type: NodePort
  ports:
  - name: sonarqube
    port: 9000
    targetPort: 9000
    protocol: TCP
  selector:
    app: sonarqube
###
# 查看
kubectl get po -n devops
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831204547.png)

```shell
# 部署jenkins
vim jenkins.yaml
###
apiVersion: v1
kind: PersistentVolume
metadata:
  name: jenkins-nfs
  namespace: devops
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: managed-nfs-storage
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /mydata/nfs/jenkins
    server: 10.15.200.242
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jenkins-pvc
  namespace: devops
spec:
  storageClassName: managed-nfs-storage
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins-admin
  namespace: devops
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jenkins-admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: jenkins-admin
  namespace: devops
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: devops
  labels:
    name: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      name: jenkins
  template:
    metadata:
      name: jenkins
      labels:
        name: jenkins
    spec:
      serviceAccountName: jenkins-admin
      hostNetwork: true
      containers:
        - name: jenkins
          image: registry.inspurcloud.cn/devops-cicd/jenkins:2.452-jdk17
          securityContext:
            privileged: true
            runAsUser: 0
          ports:
            - containerPort: 8080
            - containerPort: 50000
          env:
            - name: LIMITS_MEMORY
              valueFrom:
                resourceFieldRef:
                  resource: limits.memory
                  divisor: 1Mi
            - name: JAVA_OPTS
              value: -Xmx$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home
            - name: kubectl
              mountPath: /usr/bin/kubectl
      securityContext:
        fsGroup: 1000
      volumes:
      - name: jenkins-home
        persistentVolumeClaim:
          claimName: jenkins-pvc
      - name: kubectl
        hostPath:
          path: /usr/bin/kubectl
---
apiVersion: v1
kind: Service
metadata:
  name: jenkins-svc
  namespace: devops
spec:
  type: NodePort
  ports:
  - name: jenkins-svc
    port: 8080
    targetPort: 8080
    protocol: TCP
  selector:
    name: jenkins
###
# 部署
kubectl apply -f jenkins.yaml
# 查看
kubectl get po -n devops 
```
![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831205516.png)

查看后可以删除前两个 pod，只保留 jenkins 缓解压力

配置 gitlab (docker 环境)
```shell
# 部署gitlab
vim docker-compose.yaml
### 
version: '3.1'
services:
  gitlab:
    image: 'registry.cn-qingdao.aliyuncs.com/xuxiaoweicomcn/gitlab:17.3.1-ce.0'
    container_name: gitlab
    restart: always
    environment:
      GITLAB_OMNIBUS_CONFIG:
        external_url 'http://10.15.200.243:28080'  # 更改为自己的IP地址
        #gtilab_rails['gitlab_shell_ssh_port'] = 8822
    ports:
      - '28080:28080'
      #- '8822:8822'
    volumes:
      - './config:/etc/gitlab'
      - './logs:/var/log/gitlab'
      - './data:/var/opt/gitlab'
###
# 部署
docker compose up -d
```

查看 jenkins 与 gitlab 网页

jenkins: 

查看 service 的端口号

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831215922.png)


访问任意 k8s 节点 IP+端口号

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831215937.png)

查看 jenkins 密码
```shell
kubectl logs -n devops jenkins-7d6c69f9ff-h7869 
```
![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831224308.png)

==安装选择 (安装推荐的组件)==

安装失败则更改安装源
```shell
# kube02
vim /mydata/nfs/jenkins/hudson.model.UpdateCenter.xml 
### 替换为以下内容
<?xml version='1.1' encoding='UTF-8'?>
<sites>
  <site>
    <id>default</id>
    <url>https://mirror.esuni.jp/jenkins/updates/update-center.json </url>
  </site>
###
```

访问 gitlab（端口号 28080）

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831220005.png)

