环境：
kube 01 (8 G 内存，6 核 cpu)  10.15.200.241
kube 02 (8 G 内存，6 核 cpu)  10.15.200.242

配置 nfs
```shell
#kube01
yum install nfs-utils
vim /etc/exports
###
/mydata/nfs/jenkins *(rw,sync,no_root_squash,no_subtree_check)
/mydata/nfs/pgsql *(rw,sync,no_root_squash,no_subtree_check)
/mydata/nfs/sonarqube *(rw,sync,no_root_squash,no_subtree_check)
###
# 创建目录
mkdir -p /mydata/nfs
mkdir /mydata/nfs/pgsql
mkdir /mydata/nfs/jenkins
mkdir /mydata/nfs/sonarqube
# 重启nfs-server
systemctl restart nfs-server.service 
# 检查nfs
showmount -e 10.15.200.241
exportfs -a
exportfs -s
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831182610.png)

```shell
# 创建配置目录
kubectl create ns devops
mkdir -p /mydata/devops/sonarqube/
cd /mydata/devops/sonarqube/
# 部署postgresql
vim pgsql.yaml
###
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pgsql-nfs
  namespace: devops
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: "managed-nfs-storage"
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:  ##挂载方式
    path: /mydata/nfs/pgsql
    server: 10.15.200.241   # nfs服务端的IP地址
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-sonar
  namespace: devops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-sonar
  template:
    metadata:
      labels:
        app: postgres-sonar
    spec:
      #imagePullsecrets:
      #- name: harbor-secret
      containers:
      - name: postgres-sonar
        image: registry.inspurcloud.cn/devops-cicd/postgres:v1
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "sonarDB"
        - name: POSTGRES_USER
          value: "sonarUser"
        - name: POSTGRES_PASSWORD
          value: "admin123456"
        volumeMounts:
          - name: data
            mountPath: /var/lib/postgresql/data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: postgress-data
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-sonar
  namespace: devops
spec:
  type: NodePort
  ports:
  - name: postgres-sonar
    port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app: postgres-sonar
###
# 部署
kubectl  apply -f pgsql.yaml 
# 查看

```