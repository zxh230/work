环境：
kube 01 (8 G 内存，6 核 cpu)  10.15.200.241
kube 02 (8 G 内存，6 核 cpu)  10.15.200.242

配置 nfs
```shell
#kube02(nfs-server)
yum install nfs-utils
vim /etc/exports
###
/mydata/nfs/jenkins *(rw,sync,no_root_squash,no_subtree_check)
/mydata/nfs/pgsql *(rw,sync,no_root_squash,no_subtree_check)
/mydata/nfs/sonarqube *(rw,sync,no_root_squash,no_subtree_check)
###
# 创建目录
mkdir -p /mydata/nfs
mkdir /mydata/nfs/pgsql
mkdir /mydata/nfs/jenkins
mkdir /mydata/nfs/sonarqube
chmod 777 /mydata -R
# 重启nfs-server
systemctl restart nfs-server.service 
# 检查nfs
showmount -e 10.15.200.241
exportfs -a
exportfs -s
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831182610.png)

```shell
# kube01
# 创建配置目录
kubectl create ns devops
mkdir -p /mydata/devops/sonarqube/
cd /mydata/devops/sonarqube/
# 部署postgresql
vim pgsql.yaml
###
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pgsql-nfs
  namespace: devops
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: "managed-nfs-storage"
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /mydata/nfs/pgsql
    server: 10.15.200.242
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgress-data
  namespace: devops
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: "managed-nfs-storage"
  resources:
    requests:
      storage: 5Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-sonar
  namespace: devops
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-sonar
  template:
    metadata:
      labels:
        app: postgres-sonar
    spec:
      containers:
      - name: postgres-sonar
        image: registry.inspurcloud.cn/devops-cicd/postgres:v1
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: "sonarDB"
        - name: POSTGRES_USER
          value: "sonarUser"
        - name: POSTGRES_PASSWORD
          value: "admin123456"
        volumeMounts:
          - name: data
            mountPath: /var/lib/postgresql/data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: postgress-data
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-sonar
  namespace: devops
spec:
  type: NodePort
  ports:
  - name: postgres-sonar
    port: 5432
    targetPort: 5432
    protocol: TCP
  selector:
    app: postgres-sonar
###
# 部署
kubectl  apply -f pgsql.yaml 
# 查看
kubectl get po -n devops
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831192232.png)

```shell
# 部署sonarqube
vim bbb.yaml
### 更改IP地址为nfs-server的IP地址
apiVersion: v1
kind: PersistentVolume
metadata:
  name: sonarqube-nfs
  namespace: devops
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: "managed-nfs-storage"
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /mydata/nfs/sonarqube
    server: 10.15.200.242
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: sonarqube-data
  namespace: devops
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: "managed-nfs-storage"
  resources:
    requests:
      storage: 5Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sonarqube
  namespace: devops
  labels:
    app: sonarqube
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sonarqube
  template:
    metadata:
      labels:
        app: sonarqube
    spec:
      #imagePullsecrets:
      #- name: harbor-secret
      initContainers: ##▒~H~]▒~K▒~L~V容▒~Y▒
      - name: init-sysctl
        image: registry.inspurcloud.cn/devops-cicd/busybox:v1
        command: ["sysctl","-w","vm.max_map_count=262144"]
        securityContext:
          privileged: true
      containers:
      - name: sonarqube
        image: registry.inspurcloud.cn/devops-cicd/sonarqube:10.1.0-community
        ports:
        - containerPort: 9000
        env:
        - name: SONARQUBE_JDBC_USERNAME
          value: "sonarUser"
        - name: SONARQUBE_JDBC_PASSWORD
          value: "admin123456"
        - name: SONARQUBE_JDBC_URL
          value: "jdbc:postgresql://postgres-sonar:5432/sonarDB"
        livenessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 30
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /sessions/new
            port: 9000
          initialDelaySeconds: 30
          periodSeconds: 30
          failureThreshold: 6
        volumeMounts:
          - mountPath: /opt/sonarqube/conf
            name: data
          - mountPath: /opt/sonarqube/data
            name: data
          - mountPath: /opt/sonarqube/extensions
            name: data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: sonarqube-data
---
apiVersion: v1
kind: Service
metadata:
  name: sonarqube
  namespace: devops
spec:
  type: NodePort
  ports:
  - name: sonarqube
    port: 9000
    targetPort: 9000
    protocol: TCP
  selector:
    app: sonarqube
###
# 查看
kubectl get po -n devops
```

![image.png](https://gitee.com/zhaojiedong/img/raw/master/20240831204547.png)

```shell
# 部署jenkins

```