### 要求：
1. 使用初始化容器创建 https 的证书和密钥, 使用 deployment 部署 nginx:latest 副本 3 个, 并且启动 https 的访问.
2. 使用 poststart, 创建 index.html 页面内容为: poststart good.
3. 使用 daemonset 部署 cadvisor 和 node-exporter 在所有的节点, 且不可被驱离.
4. 使用 deployment 部署 Prometheus 服务端 和 grafana 副本各 1 个
5. 在 node1 上.访问 grafana 页面可以查看容器和主机状态
------
- 生成ssl密钥，挂载到创建nginx容器，使其支持https访问
- 使用 poststart, 创建 index.html 页面内容为: poststart good
```shell
# 创建作业目录
vim https/
cd https/
# 创建alpine.yaml文件
vim alpine.yaml
###
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-https
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      initContainers:
      - name: init-ssl
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            apk add --no-cache openssl &&
            mkdir -p /etc/nginx/ssl &&
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout /etc/nginx/ssl/tls.key \
              -out /etc/nginx/ssl/tls.crt \
              -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=mydomain.com";
        volumeMounts:
        - name: ssl-volume
          mountPath: /etc/nginx/ssl
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 443
        volumeMounts:
        - name: ssl-volume
          mountPath: /etc/nginx/ssl
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "echo 'poststart good' > /usr/share/nginx/html/index.html"]
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo 'server {
                listen 443 ssl;
                server_name mydomain.com;
                ssl_certificate /etc/nginx/ssl/tls.crt;
                ssl_certificate_key /etc/nginx/ssl/tls.key;
                location / {
                    root   /usr/share/nginx/html;
                    index  index.html index.htm;
                }
                ssl_protocols       TLSv1.2 TLSv1.3;
                ssl_ciphers         HIGH:!aNULL:!MD5;
            }' > /etc/nginx/conf.d/default.conf && \
            nginx -g 'daemon off;'
      volumes:
      - name: ssl-volume
        emptyDir: {}
###
# 注解***
# initContainers用于定义初始化任务
# alpine:latest可以更换为任意可安装 openssl 软件包的系统镜像
# 安装 openssl 软件包，生成一对密钥文件
# args:
#        - |
#           apk add --no-cache openssl &&
#           mkdir -p /etc/nginx/ssl &&
#           openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#             -keyout /etc/nginx/ssl/tls.key \
#             -out /etc/nginx/ssl/tls.crt \
#             -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=mydomain.com";
# 创建共享卷
# volumeMounts:
#       - name: ssl-volume
#         mountPath: /etc/nginx/ssl
# 之后为创建nginx pod，修改配置文件使其支持https并监听443端口，挂载共享卷共享ssl密钥
# ***
# 验证访问
curl -k https://10.10.138.61
```
验证访问结果
![](https://gitee.com/zhaojiedong/img/raw/master/202407301621943.png)
查看挂载卷 `kubectl describe pods nginx-https-545fc557f7-9gllb`
![](https://gitee.com/zhaojiedong/img/raw/master/202407301622297.png)
- - - - - -
- 使用 daemonset 部署 cadvisor 和 node-exporter 在所有的节点, 且不可被驱离
- aaaaaa