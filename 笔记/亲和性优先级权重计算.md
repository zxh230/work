### 亲和性优先级/权重计算

企业的 nodelables
[城市] – [区域] – [机房] – [机架] – [PC-X]

企业的 pod lables
[]  – []

#### 强制亲和

```shell
spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: gpu
                operator: In
                values:
                - "true"
```

#### 相对亲和

```shell
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 80
            preference:
              matchExpressions:
              - key: zone
                operator: In  
                values:
                - beijing  
          - weight: 70
            preference:  
              matchExpressions:
              - key: zone  
                operator: In  
                values:  
                - shanghai  
          - weight: 20
            preference:  
              matchExpressions:
              - key: local  
                operator: In
                values:
                - fengtai
```

preferred相对亲和的pod部署数量计算：
server02：zone=bejing 80  local=fengtai 20
server04：zone=bejing 80  local=daxing 0
server03：zone=shanghai 70 local=xujiahui 0
server05：zone=shanghai 70 local=jingan 0

sever03和server02的pod数量占比：70+0/80+40=35%
结果
如果将pod副本数量调整为10，则server2：6个pod，server3：4个pod
SelectorSpreadPriority：同一个pod调度策略中为了安全，确保不会把所有的pod调度到同一个pod上

------

```shell
# 运行镜像
kubectl run backend -l app=backend --image busybox:1.36 --image-pull-policy IfNotPresent -- sleep 1d
# 亲和

```

------

### calico 网络

IP地址由32个2进制位数构成，每8个二进制用 .  断开
IP地址被分为：网络位和主机位，分割的方法是子网掩码
子网掩码中1对应的数是网络位，0对应的是主机位
正规的算法是：ip 与 subnet = 网段

calico 的工作原理总结：
calico 是一个纯三层的虚拟网络解决方案。(二层用 vxlan 通道)
calico 为每个容器分配一个 IP，每个node 都是一个 router
简单说：每个 node 是一个独立网段

IP in ip ： ip层封装ip层
外层封装：node源/目的 ip
内层封装：pod（calico 网络的）源/目的 ip

Felix 运行在每个节点的agent进程
复制：网络接口 路由 arp 管理acl 管理信息上报
etcd：与k8s 使用相同的 etcd
复制：存储网络元数据，路由一致性(收敛状态)

------

```shell
# 更改默认IP地址池
kubectl edit ippools.crd.projectcalico.org default-ipv4-ippool
# 查看是否生效
kubectl describe ippools.crd.projectcalico.org default-ipv4-ippool
```

![image-20240725165126605](https://gitee.com/zhaojiedong/img/raw/master/image-20240725165126605.png)

------

[calicoctl](https://gitee.com/zhaojiedong/work/raw/master/%E6%96%87%E4%BB%B6/calicoctl-linux-amd64 "点击下载")

```shell
# 配置calicoctl
mv calicoctl-linux-amd64 /usr/local/sbin/calicoctl
chmod +x /usr/local/sbin/calicoctl
```

